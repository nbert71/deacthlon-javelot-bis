<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>Javelot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css"
        integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">

    <link href="main.css" rel="stylesheet">

</head>

<body>
    <header>
        <div class="info_session">
            <div><span id="pseudo">Non connecté</span></div>
            <!-- <div>Meuilleur score : <span id="meilleur_score_session">0</span></div> -->
            <a class="changer_pseudo" href="./index.html">(modifier)</a>
            
        </div>
    </header>
    <div class="main">
        <div class="pure-g">
            <div class="pure-u-5-24"></div>
            <div class="pure-u-14-24 title" style="font-family: 'Barlow Semi Condensed', sans-serif;font-weight: 900;">
                Lancer de Javelot</div>
            <div class="pure-u-5-24"></div>

            <div class="pure-u-1-3"></div>
            <div class="pure-u-1-3 score-box"
                style="font-family: 'Barlow Semi Condensed', sans-serif;font-weight: 900;">Score : <span
                    id="score">0</span></div>
            <div class="pure-u-1-3"></div>

            <div class="pure-u-5-24"></div>
            <div class="pure-u-14-24 gameover" id="gameover"
                style="font-family: 'Barlow Semi Condensed', sans-serif;font-weight: 900;">Conservez des dés et relancez
                !</div>
            <div class="pure-u-5-24"></div>

            <div class="buttons">
                <a href="./index.html" class="pure-button" id="replay" style="display: none;">Refaire une partie</a>
            </div>

            <div class="box">
                <div class="box-title">Surface de jeu</div>
                <div class="dices">
                    <div class="dice-box">
                        <div class="dice" id="dice1"></div>
                        <input type="checkbox" class="tick" id="tick1" readonly>
                    </div>

                    <div class="dice-box">
                        <div class="dice" id="dice2"></div>
                        <input type="checkbox" class="tick" id="tick2" readonly>
                    </div>

                    <div class="dice-box">
                        <div class="dice" id="dice3"></div>
                        <input type="checkbox" class="tick" id="tick3" readonly>
                    </div>

                    <div class="dice-box">
                        <div class="dice" id="dice4"></div>
                        <input type="checkbox" class="tick" id="tick4" readonly>
                    </div>

                    <div class="dice-box">
                        <div class="dice" id="dice5"></div>
                        <input type="checkbox" class="tick" id="tick5" readonly>
                    </div>

                    <div class="dice-box">
                        <div class="dice" id="dice6"></div>
                        <input type="checkbox" class="tick" id="tick6" readonly>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <a href="" class="pure-button" id="roll_dices">Lancer les dés</a>
            </div>

            <div class="buttons">
                <a href="./index.html" class="pure-button">Nouvelle partie</a>
            </div>

            <div class="rules">
                <div class="box-title">
                    Règles du jeu
                </div>
                <div class="rules-box">
                    <li>Commencez par lancer les 6 dés. Écartez alors au moins un dé. Si vous le désirez, relancez tous
                        les autres. Vous
                        pouvez réitérer l’opération plusieurs fois, à la condition de toujours écarter au moins un dé à
                        chaque coup. Mais
                        attention : seuls les dés de valeur impaire peuvent être écartés. Essayez de conserver ainsi les
                        dés de valeur
                        élevée. </li>
                    <li>À tout moment, vous pouvez décider d’interrompre vos lancers et de conclure là votre tentative.
                        Par ailleurs une
                        tentative s’achève automatiquement quand les six dés se trouvent écartés.</li>
                    <li>Si, après un lancer, vous n’êtes plus en mesure d’écarter un nouveau dé parce que tous montrent
                        une valeur paire,
                        votre tentative se solde par un échec.</li>
                </div>
            </div>

        </div>

    </div>
</body>

<script>
    function getCookie(name) {
        var cookie, c;
        cookies = document.cookie.split('; ');
        for (var i = 0; i < cookies.length; i++) {
            c = cookies[i].split('=');
            if (c[0] == name) {
                return c[1];
            }
        }
        return "";
    }

    function roll_dices() {
        document.querySelector("#roll_dices").style.visibility = 'hidden'
        data = {
            'de1_ticked': document.querySelector('#tick1').checked,
            'de2_ticked': document.querySelector('#tick2').checked,
            'de3_ticked': document.querySelector('#tick3').checked,
            'de4_ticked': document.querySelector('#tick4').checked,
            'de5_ticked': document.querySelector('#tick5').checked,
            'de6_ticked': document.querySelector('#tick6').checked,
            'cookie': getCookie("id_partie")
        }
        console.log(data)

        fetch("/roll_dices", {
                'method': "POST",
                'headers': {
                    'Content-Type': 'application/json'
                },
                'body': JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                document.querySelector('#dice1').textContent = data.de1;
                document.querySelector('#dice2').textContent = data.de2;
                document.querySelector('#dice3').textContent = data.de3;
                document.querySelector('#dice4').textContent = data.de4;
                document.querySelector('#dice5').textContent = data.de5;
                document.querySelector('#dice6').textContent = data.de6;
                document.querySelector('#score').textContent = data.score;
                if (!data.de1_active) {
                    document.querySelector("#tick1").disabled = true
                }
                if (!data.de2_active) {
                    document.querySelector("#tick2").disabled = true
                }
                if (!data.de3_active) {
                    document.querySelector("#tick3").disabled = true
                }
                if (!data.de4_active) {
                    document.querySelector("#tick4").disabled = true
                }
                if (!data.de5_active) {
                    document.querySelector("#tick5").disabled = true
                }
                if (!data.de6_active) {
                    document.querySelector("#tick6").disabled = true
                }
            })
    }

    function getDice(i) {
        return document.querySelector("#dice" + (i + 1)).textContent
    }

    function isTicked(i) {
        return document.querySelector("#tick" + (i + 1)).checked
    }

    function getSumValidTickedNumber() {
        let somme = 0;
        for (let i = 0; i < 6; i++) {
            if (isTicked(i) && parseInt(getDice(i)) % 2 != 0) {
                value = parseInt(getDice(i));
                somme += value;
            }
        }
        return somme;
    }

    function majScore(score) {
        document.querySelector("#score").textContent = score;
        document.querySelector("#roll_dices").style.visibility = 'hidden';
        if (isAnyEnabledDiceTicked()) document.querySelector("#roll_dices").style.visibility = 'visible'
    }

    function isAnyEnabledDiceTicked() {
        for (let i = 0; i < 6; i++) {
            if (isTicked(i) && !isDisabled(i) && parseInt(getDice(i)) % 2 != 0) {
                return true;
            }
        }
        return false;
    }

    function isDisabled(i) {
        return document.querySelector("#tick" + (i + 1)).disabled
    }


    // Listeners

    window.onload = (event) => {
        roll_dices()
        document.querySelector("#pseudo").textContent = getCookie("pseudo")
        event.preventDefault();
    };

    document.querySelector("#roll_dices").addEventListener("click", (event) => {
        roll_dices();
        event.preventDefault();
    });

    document.querySelector("#tick1").addEventListener("click", (event) => {
        score = getSumValidTickedNumber();
        majScore(score);
    })
    document.querySelector("#tick2").addEventListener("click", (event) => {
        score = getSumValidTickedNumber();
        majScore(score);
    })
    document.querySelector("#tick3").addEventListener("click", (event) => {
        score = getSumValidTickedNumber();
        majScore(score);
    })
    document.querySelector("#tick4").addEventListener("click", (event) => {
        score = getSumValidTickedNumber();
        majScore(score);
    })
    document.querySelector("#tick5").addEventListener("click", (event) => {
        score = getSumValidTickedNumber();
        majScore(score);
    })
    document.querySelector("#tick6").addEventListener("click", (event) => {
        score = getSumValidTickedNumber();
        majScore(score);
    })
</script>

</html>